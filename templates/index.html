<!DOCTYPE html>
<html>
<head>
    <title>Pranav's Shopify Assistant</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans">
    <header class="text-center mb-5 pt-5">
        <div class="flex items-center justify-center mb-3">
            <img src="{{ url_for('static', filename='shopify_assistant_logo.png') }}" alt="Shopify Assistant" class="h-12 mr-4">
            <h1 class="text-2xl font-bold text-shopify-purple">Pranav's Shopify Assistant</h1>
        </div>
        <p class="text-gray-600">Ask questions about your Shopify store and perform actions using natural language</p>
    </header>

    <button id="toggle-sidebar" class="fixed top-5 left-5 z-50 bg-shopify-purple text-white p-2 rounded">â˜°</button>
    <div id="sidebar" class="fixed top-0 left-0 bottom-0 w-64 bg-white border-r border-gray-200 transform -translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto z-40 pt-16">
        <div class="flex justify-between items-center p-3 border-b border-gray-200">
            <h3 class="font-semibold">Conversations</h3>
            <button id="close-sidebar" class="text-xl">&times;</button>
        </div>
        <div id="convo-list"></div>
    </div>

    <div id="chat-container" class="h-[70vh] border border-gray-300 rounded-lg overflow-y-auto p-4 mb-4 mx-auto max-w-3xl bg-white shadow-sm"></div>

    <form id="message-form" class="flex gap-3 mx-auto max-w-3xl">
        <textarea id="message-input" placeholder="Type your message here..." autocomplete="off" rows="2" class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm resize-y min-h-[50px] max-h-[200px] font-sans focus:outline-none focus:border-shopify-purple"></textarea>
        <div class="flex flex-col gap-2">
            <button type="submit" id="submit-button" class="bg-shopify-purple text-white border-none py-3 px-5 rounded-lg font-semibold shadow-sm transition-colors duration-200 hover:bg-[#4959bd]">Send</button>
            <button type="button" id="interrupt-button" class="hidden bg-red-600 text-white border-none py-3 px-5 rounded-lg font-semibold shadow-sm transition-colors duration-200 hover:bg-red-700">Stop</button>
        </div>
    </form>

    <!-- Code Interpreter Panel -->
    <div id="codeInterpreterPanel" class="hidden mt-4 border border-gray-300 rounded-lg p-3 bg-gray-50 mx-auto max-w-3xl">
      <h3 class="text-lg font-semibold mb-2">Python Code Interpreter</h3>
      <textarea id="codeEditor" class="w-full min-h-[150px] font-mono p-3 border border-gray-300 rounded mb-2"></textarea>
      <button onclick="executeCode()" class="bg-shopify-purple text-white border-none py-2 px-4 rounded font-semibold">Run Code</button>
      <div id="codeResult" class="hidden bg-gray-100 border border-gray-300 rounded p-3 font-mono whitespace-pre-wrap overflow-x-auto mt-3"></div>
    </div>

    <script>
        document.getElementById('message-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey) {
                e.preventDefault();
                document.getElementById('message-form').dispatchEvent(new Event('submit', { cancelable: true }));
            }
        });
    </script>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const submitButton = document.getElementById('submit-button');
        const interruptButton = document.getElementById('interrupt-button');
        let controller = null;
        let messageHistory = [];
        let currentConvId = null;
        // Choose backend endpoint based on path
        const apiEndpoint = window.location.pathname === '/responses' ? '/chat_responses' : '/chat';

        const toggleBtn = document.getElementById('toggle-sidebar');
        const sidebar = document.getElementById('sidebar');
        const closeBtn = document.getElementById('close-sidebar');
        toggleBtn.addEventListener('click', () => sidebar.classList.toggle('translate-x-0'));
        closeBtn.addEventListener('click', () => sidebar.classList.remove('translate-x-0'));

        function loadSidebarList() {
            fetch('/conversations')
              .then(res => res.json())
              .then(convs => {
                const list = document.getElementById('convo-list');
                list.innerHTML = '';
                convs.forEach(c => {
                  const item = document.createElement('div');
                  item.className = 'p-3 border-b border-gray-200 cursor-pointer flex justify-between items-center hover:bg-gray-100';
                  item.dataset.id = c.id;
                  const label = document.createElement('span');
                  label.textContent = `${c.title} (${new Date(c.created_at).toLocaleString()})`;
                  label.addEventListener('click', () => loadConversation(c.id));
                  const del = document.createElement('button');
                  del.className = 'text-red-600 bg-transparent border-none cursor-pointer';
                  del.textContent = 'ðŸ—‘';
                  del.addEventListener('click', e => { e.stopPropagation(); deleteConversation(c.id, item); });
                  item.appendChild(label);
                  item.appendChild(del);
                  list.appendChild(item);
                });
              });
        }

        function loadConversation(id) {
            fetch(`/conversations/${id}`)
              .then(res => res.json())
              .then(msgs => {
                currentConvId = id;
                messageHistory = [];
                chatContainer.innerHTML = '';
                msgs.forEach(m => addMessage(m.content, m.role));
              });
        }

        function deleteConversation(id, elem) {
            fetch(`/conversations/${id}`, { method: 'DELETE' })
              .then(() => {
                elem.remove();
                if (currentConvId == id) { chatContainer.innerHTML = ''; currentConvId = null; messageHistory = []; }
              });
        }

        loadSidebarList();

        // Add initial assistant message
        addMessage('Hello! I\'m your Shopify assistant. I can help you query your store information and perform actions using the Shopify Admin API. What would you like to do today?', 'assistant');

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;

            // Add user message to UI
            addMessage(message, 'user');
            messageInput.value = '';

            // Disable input while processing
            messageInput.disabled = true;
            submitButton.disabled = true;

            // Show loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'flex items-center justify-center my-4';
            loadingDiv.innerHTML = '<div class="animate-bounce mx-1 h-2 w-2 bg-shopify-purple rounded-full"></div><div class="animate-bounce mx-1 h-2 w-2 bg-shopify-purple rounded-full" style="animation-delay: -0.32s;"></div><div class="animate-bounce mx-1 h-2 w-2 bg-shopify-purple rounded-full" style="animation-delay: -0.16s;"></div>';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            let prevResponseId = window.prevResponseId || null;
            try {
                // Create an AbortController
                controller = new AbortController();
                interruptButton.style.display = 'block';

                // Send request to backend
                const response = await fetch(apiEndpoint, {
                    signal: controller.signal,
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message,
                        conv_id: currentConvId,
                        prev_response_id: prevResponseId
                    })
                });

                const data = await response.json();

                // Remove loading indicator
                chatContainer.removeChild(loadingDiv);

                // Update current conv_id
                currentConvId = data.conv_id;

                // Update prevResponseId for stateless Responses API
                window.prevResponseId = data.response_id || null;

                // Add assistant message to UI
                addMessage(data.response, 'assistant', data.suggestions);

                // Log tool calls for debugging
                if (data.tool_calls && data.tool_calls.length > 0) {
                    console.log('Tool calls:', data.tool_calls);
                }

                loadSidebarList();
            } catch (error) {
                console.error('Error:', error);
                // Remove loading indicator
                chatContainer.removeChild(loadingDiv);
                if (error.name === 'AbortError') {
                    addMessage('Request cancelled by user.', 'assistant');
                } else {
                    addMessage('Sorry, there was an error processing your request.', 'assistant');
                }
            } finally {
                // Re-enable input and hide interrupt button
                messageInput.disabled = false;
                submitButton.disabled = false;
                messageInput.focus();
                interruptButton.style.display = 'none';
                controller = null;
            }
        });

        // Handle interrupt button click
        interruptButton.addEventListener('click', () => {
            if (controller) {
                controller.abort();
                controller = null;
                interruptButton.style.display = 'none';
            }
        });

        // Handle suggestion clicks
        function handleSuggestionClick(suggestion) {
            messageInput.value = suggestion;
            messageForm.dispatchEvent(new Event('submit'));
        }

    // Code Interpreter Functions
    function toggleCodePanel() {
      const panel = document.getElementById('codeInterpreterPanel');
      panel.style.display = panel.style.display === 'none' || panel.style.display === '' ? 'block' : 'none';
    }

    async function executeCode() {
      const codeEditor = document.getElementById('codeEditor');
      const codeResult = document.getElementById('codeResult');
      const code = codeEditor.value.trim();

      if (!code) {
        alert('Please enter some code to execute');
        return;
      }

      try {
        codeResult.textContent = 'Running...';
        codeResult.style.display = 'block';

        const response = await fetch('/execute_code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            code: code,
            store_in_conversation: true,
            conv_id: currentConvId
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        // Display results
        let output = '';
        if (result.status === 'success') {
          output += result.output;
          if (result.error) {
            output += '\n\nErrors:\n' + result.error;
          }
        } else {
          output = 'Error: ' + result.error;
        }

        codeResult.textContent = output || 'Code executed with no output';

        // If we're in a conversation, refresh the chat to show the new messages
        if (currentConvId) {
          loadConversation(currentConvId);
        }
      } catch (error) {
        codeResult.textContent = 'Error: ' + error.message;
      }
    }


        function addMessage(content, role, suggestions = []) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('mb-4', 'p-3', 'rounded-lg', 'max-w-[80%]', 'relative');

            if (role === 'user') {
                messageDiv.classList.add('bg-shopify-purple', 'text-white', 'ml-auto');
            } else {
                messageDiv.classList.add('bg-gray-100', 'text-gray-800');
            }

            // Use Showdown to convert Markdown to HTML
            const converter = new showdown.Converter();
            converter.setOption('tables', true);
            const htmlContent = converter.makeHtml(content);
            messageDiv.innerHTML = htmlContent;

            // Add suggestions if they exist and this is an assistant message
            if (role === 'assistant' && suggestions && suggestions.length > 0) {
                const suggestionsDiv = document.createElement('div');
                suggestionsDiv.classList.add('flex', 'flex-wrap', 'gap-2', 'mt-2');
                suggestions.forEach(suggestion => {
                    const suggestionButton = document.createElement('button');
                    suggestionButton.classList.add('bg-gray-200', 'text-gray-700', 'border', 'border-gray-300', 'px-3', 'py-1', 'rounded-full', 'text-sm', 'transition-colors', 'hover:bg-shopify-purple', 'hover:text-white', 'hover:border-shopify-purple');
                    suggestionButton.textContent = suggestion;
                    suggestionButton.onclick = () => handleSuggestionClick(suggestion);
                    suggestionsDiv.appendChild(suggestionButton);
                });
                messageDiv.appendChild(suggestionsDiv);
            }

            // Add timestamp
            const timeDiv = document.createElement('div');
            timeDiv.classList.add('text-xs', 'text-gray-500', 'mt-1', 'text-right');
            const now = new Date();
            timeDiv.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            messageDiv.appendChild(timeDiv);

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Add to history
            messageHistory.push({ role, content });
        }
    </script>
</body>
</html>